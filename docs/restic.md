# Using Restic

## Using Restic with nix

Restic backups are exposed as a service in nix under [`services.restic.backups`](https://search.nixos.org/options?channel=unstable&from=0&size=50&sort=relevance&type=packages&query=services.restic.backup). When you add a new entry, the service will generate a wrapper script with all the required ENV variables set. For example for `services.restic.backup.example` there will be `restic-example` available in machine's shell.

## Initializing new repository with Backblaze

1. Go to [Backblaze](https://secure.backblaze.com/b2_buckets.htm) and create new Bucket.
   1. The bucket name has to be unique across all backblaze buckets of all users. So use naming scheme like `<something>-backup-<random>`. Random can be obtained from `pwgen`, for example `nix run nixpkgs#pwgen -- --secure 10 1`
2. Generate an app key for the bucket in [Backblaze](https://secure.backblaze.com/app_keys.htm)
3. `home-server-nixos-secrets` create new files, fill the information and encrypt new secrets:
   1. `<something>_restic_password.txt`
      1. Come up with a password to encrypt the data with
   2. `<something>_restic_repository.txt`
      1. Should follow the scheme `s3:<endpoint>/<bucket>`, for example: `s3:s3.us-east-002.backblazeb2.com/example-backup-xKA5gp6vPG`
   3. `<something>_restic_environment.env`
      1. Add the following content:
      ```
      AWS_ACCESS_KEY_ID="<app_key_id_from_backblaze>"
      AWS_SECRET_ACCESS_KEY="<app_key_from_backblaze>"
      ```
4. Add new entry in `services.restic.backups.<something>` with secret values
   ```nix
   environmentFile = config.age.secrets.<something>_restic_environment.path;
   repositoryFile = config.age.secrets.<something>_restic_repository.path;
   passwordFile = config.age.secrets.<something>_restic_password.path;
   ```
5. Deploy new config
6. Run `restic-<something> init` to initialize the repository

## Restic cheatsheet

The following cheatsheet assumes all the required ENV variables are available. The following commands can also be used with `restic-<something>` generated by NixOS module.

### Initializing repository

```shell
restic init
```

### Backup

```shell
restic backup /path/to/backup
```

### List snapshots

```shell
restic snapshots
```

### See the diff between snapshots

```shell
restic diff <snapshot_1_hash> <snapshot_2_hash>
```

### List files in snapshot

```shell
restic ls -l <snapshot_hash>
```
